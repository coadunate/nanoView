<!doctype html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="../style/pileup.css" />
<link rel="stylesheet" href="demo.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<style>


  text {
      font: 10px sans-serif;
  }

  .plot {
      position: absolute;
  }

  #plot-canvas {
      z-index: 2;
  }

  #axis-svg {
      z-index: 1;
  }

  .axis path,
  .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
  }

  .tick line{
      opacity: 0.2;
  }
</style>
</head>

<body>

</div>
<div style="margin-left: 500px;display:inline-block;padding-top:5px;" id="mainButtons"></div>
<br />
<img id="infoImage" src="tayab.png" style="margin-left: 100px;margin-top: 50px;" width="1268" height="500" alt="">
<br />
<svg id="axis-svg" class="plot"></svg>
<canvas id="plot-canvas" class="plot"></canvas>
<div id="pileup"></div>
</body>

<script src="../node_modules/stats.js/build/stats.min.js"></script>
<script src="../dist/pileup.js"></script>
<!-- or:
<script src="../dist/pileup.min.js"></script>
-->

<script src="data.js"></script>
<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.12/d3.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>
<script src="playground.js"></script>
<script type="text/javascript">

  addons = {
    line: true,
    non_basecalled: false
  }

  var mainButtonsDiv = document.getElementById("mainButtons");

  var imageInput = document.createElement("INPUT");
  imageInput.setAttribute("type","text");
  imageInput.setAttribute("placeholder","image URL");
  mainButtonsDiv.appendChild(imageInput);

  mainButtonsDiv.appendChild(document.createElement('span').appendChild(document.createTextNode(' ')))

  var infoImage = document.getElementById("infoImage");

  var imgButton = document.createElement("BUTTON");
  imgButton.appendChild(document.createTextNode("Load Image"));
  // imgButton.classList.add("btn");
  // imgButton.classList.add("btn-primary");
  mainButtonsDiv.appendChild(imgButton);
  imgButton.addEventListener('click',function(){
    document.getElementsByClassName("signalplot")[0].style.minHeight= "1030px";
    infoImage.src = imageInput.value;
  });

  mainButtonsDiv.appendChild(document.createElement('span').appendChild(document.createTextNode(' ')))

  var unloadImage = document.createElement("BUTTON");
  unloadImage.appendChild(document.createTextNode("Unload Image"));
  // unloadImage.classList.add("btn");
  // unloadImage.classList.add("btn-primary");
  mainButtonsDiv.appendChild(unloadImage);
  unloadImage.addEventListener('click',function(){
    document.getElementsByClassName("signalplot")[0].style.minHeight= "500px";
    infoImage.src="";

  });

  mainButtonsDiv.appendChild(document.createElement('span').appendChild(document.createTextNode(' ● ')))

  var albacoreButton = document.createElement('BUTTON');
  albacoreButton.appendChild(document.createTextNode("ALBACORE EVENTS"));
  // albacoreButton.classList.add("btn");
  // albacoreButton.classList.add("btn-default");
  mainButtonsDiv.appendChild(albacoreButton);
  albacoreButton.addEventListener('click',function(){
    removeRendering();
    renderEventData('206.167.183.18','tombo-may26',0,addons);
    showButtons('albacore');
  });

  albacorePlusRawButton = document.createElement("BUTTON");
  albacorePlusRawButton.appendChild(document.createTextNode("ALBACORE + RAW SIGNAL"));
  mainButtonsDiv.appendChild(albacorePlusRawButton);
  albacorePlusRawButton.addEventListener('click',function(){
    removeRendering();
    showButtons();
  });

  mainButtonsDiv.appendChild(document.createElement('span').appendChild(document.createTextNode(' ')))

  tomboButton = document.createElement("BUTTON")
  tomboButton.appendChild(document.createTextNode("TOMBO EVENTS"));
  // tomboButton.classList.add("btn");
  // tomboButton.classList.add("btn-default");
  mainButtonsDiv.appendChild(tomboButton);
  tomboButton.addEventListener('click',function(){
    removeRendering();
    renderEventData('206.167.183.18','tombo-may26',1,addons);
    showButtons('tombo');
  });

  mainButtonsDiv.appendChild(document.createElement('span').appendChild(document.createTextNode(' ')))

  tomboPlusRawButton = document.createElement("BUTTON");
  tomboPlusRawButton.appendChild(document.createTextNode("TOMBO EVENTS + RAW SIGNAL"));
  // tomboPlusRawButton.classList.add("btn");
  // tomboPlusRawButton.classList.add("btn-default");
  mainButtonsDiv.appendChild(tomboPlusRawButton);
  tomboPlusRawButton.addEventListener('click',function(){
    removeRendering();
    addons.non_basecalled = true;
    renderEventData('206.167.183.18','tombo-may26',2,addons);
    showButtons('tombo-png');
  });



  mainButtonsDiv.appendChild(document.createElement('span').appendChild(document.createTextNode(' || → ')))

  var additionalButtons = document.createElement("div");
  additionalButtons.setAttribute("style","display:inline-block");
  mainButtonsDiv.append(additionalButtons);

  function showButtons(dataset='none'){
    while(additionalButtons.firstChild){
      additionalButtons.removeChild(additionalButtons.firstChild);
    }
    if(dataset == 'albacore'){
      var b1 = document.createElement('BUTTON');
      var t1 = document.createTextNode("TOGGLE LINES");
      b1.appendChild(t1);
      additionalButtons.appendChild(b1);
      b1.addEventListener('click',function(){
        removeRendering();
        addons.line = !addons.line;
        renderEventData('206.167.183.18','tombo-may26',0,addons);
      });

      additionalButtons.appendChild(document.createElement("span").appendChild(document.createTextNode(" -- ")));

      var b3 = document.createElement("BUTTON");
      var t3 = document.createTextNode("TOGGLE NON-BASECALLED");
      b3.appendChild(t3);
      additionalButtons.appendChild(b3);
      b3.addEventListener('click',function(){
        removeRendering();
        addons.non_basecalled = !addons.non_basecalled;
        renderEventData('206.167.183.18','tombo-may26',0,addons);
      });
    } else if(dataset == 'tombo'){
      var b4 = document.createElement("BUTTON");
      b4.appendChild(document.createTextNode("TOGGLE LINES"));
      additionalButtons.appendChild(b4);
      b4.addEventListener('click',function(){
        removeRendering();
        addons.line = !addons.line;
        renderEventData('206.167.183.18','tombo-may26',1,addons);
      });

    } else if(dataset == 'tombo-png'){
      var b5 = document.createElement("BUTTON");
      b5.appendChild(document.createTextNode("TOGGLE LINE"));
      additionalButtons.append(b5);
      b5.addEventListener('click',function(){
        removeRendering();
        addons.line = !addons.line;
        renderEventData('206.167.183.18','tombo-may26',2,addons);
      });
    }
  }
</script>
<script>

  // define all size variables
  var margin = {top: 60, right: 10, bottom: 30, left: 120};
  var fullWidth = window.innerWidth - margin.right;
  var fullHeight = 500;
  var width = fullWidth - margin.left - margin.right;
  var height = fullHeight - margin.top - margin.bottom;

  // the canvas is shifted by 1px to prevent any artefacts
  // when the svg axis and the canvas overlap
  var canvas = d3.select("#plot-canvas")
      .attr("width", width - 1)
      .attr("height", height - 1)
      .style("transform", "translate(" + (margin.left + 1) +
          "px" + "," + (margin.top + 1) + "px" + ")");


  var svg = d3.select("#axis-svg")
      .attr("width", fullWidth)
      .attr("height", fullHeight)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," +
          (margin.top) + ")");


  // get the canvas drawing context
  var context = canvas.node().getContext('2d');

  function removeRendering(){
    context.clearRect(0, 0, fullWidth, fullHeight);
    svg.selectAll("*").remove();
  }

  function renderEventData(url,datasetname, dataType, addition = {lines: false}){
    var pileupRange = p.getRange() ? p.getRange() : range;
    // constants
    var subsetSize = 100;
    var drawingOptions = {
      pointRadius: 3,
      lineWidth: 3,
      lineColor: 'blue'
    }

    var READ_COLORS = [
      "#F5A9A9",
      "#F3E2A9",
      "#BEF781",
      "#81F79F",
      "#81F7D8",
      "#58ACFA",
      "#8258FA",
      "#9A2EFE",
      "#FE2EF7"
    ];

    // save the index of the currently selected point
    var selectedPoint;



    // generate random dataset
    var randomX = d3.random.normal(0, 30);
    var randomY = d3.random.normal(0, 30);

    // var data = d3.range(numberPoints).map(function(d, i) {
    //     return {
    //         x: randomX(),
    //         y: randomY(),
    //         i: i, // save the index of the point as a property, this is useful
    //         selected: false
    //     };
    // });

    var data = [];

    /** Returns a JSON array containing the event information of the given range. */
    var getEventData = function(range) {
      var result = [];
      var xhttp = new XMLHttpRequest();

      xhttp.open("GET", "http://" + url + ":5000/getall/name=" + datasetname + "&data="  + dataType, false);
      xhttp.onload = function() {
        result = JSON.parse(xhttp.responseText);
      };
      xhttp.send();
      var eventData = [];
      var finalDataset = [];
      for(var i = 0; i < result.length; i++){
        if(i%2!=0){
          var x = []; // contains [x,cigarStatus]
          var y = [];
          var subEv = [];
          if(dataType == 1 || dataType == 2){ // tombo dataset is enclosed in an arry.
            for(var j = 0; j < result[i][0].length; j++){
                if(j%2!= 0){
                subEv.push(result[i][0][j]);
              }
            }
          } else if(dataType == 0){
            for(var j = 0; j < result[i].length; j++){
              if(j%2!= 0){
                subEv.push(result[i][j]);
              }
            }
          }
          for(var k = 0; k < subEv.length; k++){
            for(var l = 0; l < subEv[k].length; l++){
              var _x = [];
              _x.push(subEv[k][l][0]); // x value
              _x.push(subEv[k][l][0]); // cigar status
              x.push(_x);
              y.push(Number(subEv[k][l][1]));

            }
          }


          eventData.push(x);
          eventData.push(y);

        }
      }
      finalReads = [];
      for(var x =0; x < eventData.length; x += 2){
        console.log(result[x])
        if(result[x] == '1182ad2e-10aa-421a-8fd3-39256b62a11b'){
          var arr = [];
          arr.push(eventData[x]);
          arr.push(eventData[x+1]);
          arr.push(result[x]);
          finalReads.push(arr);
        }
      }
      return finalReads;
      // event.preventDefault();
    }

    resultEvent = getEventData(range);
    console.log(resultEvent);
    var data = [];
    for(var x = 0; x < resultEvent.length; x++){
      var inter_data = [];
      for(var a = 0; a < resultEvent[x][0].length; a++){
        if(dataType == 2){
          var datum = {
            y: resultEvent[x][0][a][0], // x value
            x: resultEvent[x][1][a],
            name: resultEvent[x][2],
            cigarStatus: resultEvent[x][0][a][1], // Cigar status
            i: a,
            selected: false

          }
        } else{
          var datum = {
            x: resultEvent[x][0][a][0], // x value
            y: resultEvent[x][1][a],
            name: resultEvent[x][2],
            cigarStatus: resultEvent[x][0][a][1], // Cigar status
            i: a,
            selected: false

          }
        }
        inter_data.push(datum);

      }
      data.push(inter_data);
    }


    var xRange = [Infinity,-Infinity];
    var yRange = [Infinity,-Infinity];
    data.forEach(function(d,i){
      var _xRange = d3.extent(d, function(e){ return e.x });

      if(_xRange[0] < xRange[0]) xRange[0] = _xRange[0];
      if(_xRange[1] > xRange[1]) xRange[1] = _xRange[1];

      var _yRange = d3.extent(d, function(e){ return e.y; });

      if(_yRange[0] < yRange[0]) yRange[0] = _yRange[0];
      if(_yRange[1] > yRange[1]) yRange[1] = _yRange[1];

    });
    var xScale = d3.scale.linear()
        .domain([3,4])
        .range([0, width]);

    // var yScale = d3.scale.linear()
    //     .domain([yRange[0] - 5, yRange[1] + 5])
    //     .range([height, 0]);


    var yScale = d3.scale.linear()
        .domain([-3,3])
        .range([height, 0]);

    var xAxis = d3.svg.axis()
        .scale(xScale)
        .innerTickSize(-height)
        .outerTickSize(0)
        .tickPadding(10)
        .orient('bottom');

    var yAxis = d3.svg.axis()
        .scale(yScale)
        .innerTickSize(-width)
        .outerTickSize(0)
        .orient('left');

    // create zoom behaviour
    var zoomBehaviour = d3.behavior.zoom()
        .x(xScale)
        .y(yScale)
        .scaleExtent([1, 1000])
        .on("zoom", onZoomEnd)
        .on("zoomend", onZoomEnd);

    // zoomBehaviour.scale(57,5);

    // append x-axis, y-axis
    var xAxisSvg = svg.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis);

    var yAxisSvg = svg.append('g')
        .attr('class', 'y axis')
        .call(yAxis);

    // // on onclick handler
    // canvas.on("click", onClick);

    // add zoom behaviour
    canvas.call(zoomBehaviour);


    draw(null,drawingOptions);

    function onClick() {
        // var mouse = d3.mouse(this);
        //
        // // map the clicked point to the data space
        // var xClicked = xScale.invert(mouse[0]);
        // var yClicked = yScale.invert(mouse[1]);
        //
        // // find the closest point in the dataset to the clicked point
        // var closest = quadTree.find([xClicked, yClicked]);
        //
        // // map the co-ordinates of the closest point to the canvas space
        // var dX = xScale(closest.x);
        // var dY = yScale(closest.y);
        //
        // // register the click if the clicked point is in the radius of the point
        // var distance = euclideanDistance(mouse[0], mouse[1], dX, dY);
        //
        // if(distance < pointRadius) {
        //     if(selectedPoint) {
        //         data[selectedPoint].selected = false;
        //     }
        //     closest.selected = true;
        //     selectedPoint = closest.i;
        //
        //     // redraw the points
        //     //draw(null,drawingOptions);
        // }
    }

    function onZoom() {
        // clearTimeout(zoomEndTimeout);
        // draw(randomIndex,drawingOptions);
        // xAxisSvg.call(xAxis);
        // yAxisSvg.call(yAxis);
        var _range = {contig: 'burn-in', start: Math.round(xScale.domain()[0]), stop: Math.round(xScale.domain()[1]) };
        p.setRange(_range);
    }

    function onZoomEnd(dOpts) {
        // when zooming is stopped, create a delay before
        // redrawing the full plot

        var midPoint = Math.round(xScale.domain()[0] + (xScale.domain()[1]-xScale.domain()[0])/2);
        if(dOpts)
          draw(null,dOpts,midPoint);
        else
          draw(null,drawingOptions,midPoint);
        xAxisSvg.call(xAxis);
        yAxisSvg.call(yAxis);


        var _range = {contig: 'burn-in', start: Math.round(xScale.domain()[0]), stop: Math.round(xScale.domain()[1]) };

        p.setRange(_range);

        context.beginPath();
        context.setLineDash([15, 20]);
        context.moveTo(xScale(midPoint),yScale(-20));
        context.lineTo(xScale(midPoint),0);
        context.strokeStyle="black";
        context.lineWidth=1;
        context.closePath();
        context.stroke();

        context.beginPath();
        context.moveTo(xScale(midPoint-1),yScale(-20));
        context.lineTo(xScale(midPoint-1),0);
        context.strokeStyle="black";
        context.lineWidth=1;
        context.closePath();
        context.stroke();

        context.setLineDash([0, 0]);

    }

    // the draw function draws the full dataset if no index
    // parameter supplied, otherwise it draws a subset according
    // to the indices in the index parameter
    function draw(index=null,options,mid_point) {
        var active;

        context.clearRect(0, 0, fullWidth, fullHeight);
        context.strokeWidth = 1;
        context.strokeStyle = 'blue';
        // if an index parameter is supplied, we only want to draw points
        // with indices in that array
        if(index) {
            index.forEach(function(i) {
              for(var j = 0; j < data.length; j++){
                var point = data[j][i];
                var nextPoint = i < data[j].length-1 ? data[j][i+1] : 0;
                context.beginPath();
                drawLine(point, 2,nextPoint,options, mid_point);
              }

            });
        }
        // draw the full dataset otherwise
        else {
            //data.sort(function(a,b){ return a[0].name.localeCompare(b[0].name); });
            for(var m = 0; m < data.length; m++){
              drawingOptions.lineColor = READ_COLORS[m];
              for(var i = 0; i < data[m].length; i++){
                var point = data[m][i];
                var nextPoint = i < data[m].length-1 ? data[m][i+1] : 0;
                context.beginPath();
                drawLine(point,options.pointRadius, nextPoint, drawingOptions, mid_point);
                //console.log(point.name);
              }
            }
        }
    }

    function drawLine(point, r, nextPoint,options, mPoint) {
        if(addition.non_basecalled || (!addition.non_basecalled && (point.x%1 == 0 && nextPoint.x %1 == 0)) ) { // NON BASECALLED
          var cx = xScale(point.x);
          var cy = yScale(point.y);

          var nX = xScale(nextPoint.x);
          var nY = yScale(nextPoint.y);

          // console.log("POINTX: " + point.x);


          if(addition.line){
            // context.beginPath();
            context.lineTo(cx,cy);
            context.lineTo(nX,cy);
            context.lineTo(nX,nY);
            context.lineWidth= options.lineWidth;
            context.strokeStyle=options.lineColor;
            // context.closePath();
            context.stroke();
          }

          if(point.x %1 != 0){
            context.fillStyle="gray";
          }else{
            context.fillStyle=options.lineColor;
          }
          context.beginPath();
          context.arc(cx, cy, r, 0, 2 * Math.PI);
          context.closePath();
          context.fill();
      }



    }

    function euclideanDistance(x1, y1, x2, y2) {
        return Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1));
    }
  }

</script>
